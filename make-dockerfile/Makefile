REGISTRY ?= registry.cn-hangzhou.aliyuncs.com/bocloud

DEV_REGISTRY ?= deploy.bocloud.k8s:40443/aios

IMAGE_NAME ?= aios-automl

BIN_NAME = aios-automl

VERSION ?= v1.0

RELEASE_TAG = $(VERSION)

TIME_STAMP = $(shell date +%Y%m%d%H%M)

# ç‰ˆæœ¬é•œåƒæŒ‡å®šé•œåƒä»“åº“
RELEASE_IMG ?= $(REGISTRY)/$(IMAGE_NAME):$(RELEASE_TAG)

COMMIT_ID=$(shell git rev-parse HEAD)
BUILD_TIME=$(shell date +'%Y-%m-%dT%H:%M')
HOST_ARCH=$(shell go env GOHOSTARCH)
HOST_OS=$(shell go env GOHOSTOS)

.PHONY: all
all: release


EMPTY :=
SPACE := $(EMPTY) $(EMPTY)
COMMA := ,
PLATFORMS ?=amd64 arm64

#--pushè¡¨ç¤ºå°†é•œåƒæŽ¨é€åˆ°è¿œç¨‹ä»“åº“ã€‚
#--progress plainè¡¨ç¤ºæ˜¾ç¤ºç®€å•çš„è¿›åº¦ä¿¡æ¯ã€‚
#--platform $(subst $(SPACE),$(COMMA),$(PLATFORMS))è¡¨ç¤ºæž„å»ºå¤šä¸ªå¹³å°çš„é•œåƒï¼Œå¦‚arm64å’Œamd64ã€‚

.PHONY: release  # Build a multi-arch docker image
release: bin release-binaries record-build-info  ## åŒæ—¶æ‰“åŒ…arm64ï¼Œamd64é•œåƒå¹¶ä¸Šä¼ åˆ°ä»“åº“.ä½¿ç”¨å‰å…ˆä¿®æ”¹ REGISTRYå‚æ•°
	echo "Building and pushing image..."
	@docker buildx build \
		--push \
		--progress plain \
		--platform $(subst $(SPACE),$(COMMA),$(PLATFORMS)) \
		--build-arg COMMIT_ID=${COMMIT_ID} \
		--build-arg BUILD_TIME=${BUILD_TIME} \
		--build-arg VERSION=${VERSION} \
		-t $(RELEASE_IMG) .
	$(MAKE) migrate
	# release external image: $(RELEASE_IMG)
	echo "release image time: $(TIME_STAMP)" >> BUILD_INFO
	echo "release external image: $(RELEASE_IMG)" >> BUILD_INFO


# -trimpath - åœ¨è¿è¡Œæ—¶åˆ é™¤äºŒè¿›åˆ¶æ–‡ä»¶ä¸­çš„ç¬¦å·è¡¨ä¿¡æ¯ï¼Œä»¥å‡å°æ–‡ä»¶å¤§å°ã€‚
# -ldflags="-s -w" - è¿™æ˜¯é“¾æŽ¥å™¨æ ‡å¿—ï¼Œç”¨äºŽæŽ§åˆ¶ç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶çš„è¡Œä¸ºã€‚-sè¡¨ç¤ºåŽ»é™¤è°ƒè¯•ä¿¡æ¯ï¼Œ-wè¡¨ç¤ºåŽ»é™¤æ‰€æœ‰ç¬¦å·ä¿¡æ¯(å¦‚å‡½æ•°åã€å˜é‡åç­‰)ã€‚
# -X è¿™äº›æ˜¯ä¼ é€’ç»™äºŒè¿›åˆ¶æ–‡ä»¶çš„è‡ªå®šä¹‰å±žæ€§ã€‚è¿™äº›å±žæ€§å¯ä»¥åœ¨è¿è¡Œæ—¶é€šè¿‡åå°„è¿›è¡Œè®¿é—®å’Œä¿®æ”¹ã€‚
.PHONY: build
build: ## Build manager binary.
	CGO_ENABLED=0 GOOS=linux GOARCH=${HOST_ARCH} \
        go build  \
		-trimpath \
        -ldflags="-s -w \
                  -X main.GitCommitID=${COMMIT_ID}  \
                  -X main.Architecture=${HOST_OS}/${HOST_ARCH} \
                  -X main.BuildTime=${BUILD_TIME} \
                  -X main.Version=${VERSION}" \
        -o bin/$(BIN_NAME)-${HOST_ARCH} .

.PHONY: release-binaries
release-binaries: clean
	$(foreach PLATFORM,$(PLATFORMS), echo -n "$(PLATFORM)..."; make build HOST_ARCH=$(PLATFORM);)

#.PHONY: migrate
#migrate: migrate-image migrate-image-dev
#
#.PHONY: migrate-image
#migrate-image: ## Migrate image to BKE registry
#	@bke registry sync --dest-tls-verify --source $(RELEASE_IMG) --target $(BKE_REGISTRY_IMG) --multi-arch
#
#.PHONY: migrate-image-dev
#migrate-image-dev: ## Migrate image to local registry
#	@bke registry sync --dest-tls-verify --source $(RELEASE_IMG) --target $(LOCAL_DEV_IMG) --multi-arch


.PHONY: record-build-info
record-build-info:
	echo -e "\n" >> BUILD_INFO
	echo "ðŸ¤¯ Version=${VERSION}" >> BUILD_INFO
	echo "ðŸ¤” GitCommitId=${COMMIT_ID}" >> BUILD_INFO
	echo "ðŸ‘‰ Architecture=${HOST_ARCH}" >> BUILD_INFO
	echo "â² BuildTime=${BUILD_TIME}" >> BUILD_INFO

.PHONY: bin
bin:
	if [ ! -d bin ]; then mkdir bin; fi

.PHONY: clean
clean:
	rm -f bin/$(BIN_NAME)*